events {
    worker_connections 1024;
}

http {
    # Upstream servers
    upstream jenkins {
        server jenkins:8080;
    }

    upstream kanban {
        server kanban:80;
    }

    upstream excalidraw {
        server excalidraw:80;
    }

    upstream drawio {
        server drawio:8080;
    }

    upstream startpage {
        server dashboard:8080;
    }

    upstream tempmail {
        server tempmail:80;
    }

    upstream semaphore {
        server semaphore:3000;
    }

    #
    # -----------------------------
    # HTTP â†’ HTTPS redirect
    # -----------------------------
    server {
        listen 80;
        server_name jenkins.hs kanban.hs draw.hs diagram.hs startpage.hs tempmail.hs semaphoreui.hs;
        return 301 https://$host$request_uri;
    }

    #
    # -----------------------------
    # Jenkins (HTTPS)
    # -----------------------------
    server {
        listen 443 ssl;
        server_name jenkins.hs;

        ssl_certificate     /etc/nginx/certs/jenkins.hs+6.pem;
        ssl_certificate_key /etc/nginx/certs/jenkins.hs+6-key.pem;

        location / {
            proxy_pass http://jenkins;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    #
    # -----------------------------
    # Kanban (HTTPS)
    # -----------------------------
    server {
        listen 443 ssl;
        server_name kanban.hs;

        ssl_certificate     /etc/nginx/certs/jenkins.hs+6.pem;
        ssl_certificate_key /etc/nginx/certs/jenkins.hs+6-key.pem;

        location / {
            proxy_pass http://kanban;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    #
    # -----------------------------
    # Excalidraw (HTTPS)
    # -----------------------------
    server {
        listen 443 ssl;
        server_name draw.hs;

        ssl_certificate     /etc/nginx/certs/jenkins.hs+6.pem;
        ssl_certificate_key /etc/nginx/certs/jenkins.hs+6-key.pem;

        location / {
            proxy_pass http://excalidraw;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    #
    # -----------------------------
    # Draw.io (HTTPS)
    # -----------------------------
    server {
        listen 443 ssl;
        server_name diagram.hs;

        ssl_certificate     /etc/nginx/certs/jenkins.hs+6.pem;
        ssl_certificate_key /etc/nginx/certs/jenkins.hs+6-key.pem;

        location / {
            proxy_pass http://drawio;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    #
    # -----------------------------
    # Startpage (HTTPS)
    # -----------------------------
    server {
        listen 443 ssl;
        server_name startpage.hs;

        ssl_certificate     /etc/nginx/certs/jenkins.hs+6.pem;
        ssl_certificate_key /etc/nginx/certs/jenkins.hs+6-key.pem;

        location / {
            proxy_pass http://startpage;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    #
    # -----------------------------
    # TempMail (HTTPS)
    # -----------------------------
    server {
        listen 443 ssl;
        server_name tempmail.hs;

        ssl_certificate     /etc/nginx/certs/jenkins.hs+6.pem;
        ssl_certificate_key /etc/nginx/certs/jenkins.hs+6-key.pem;

        location / {
            proxy_pass http://tempmail;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    #
    # -----------------------------
    # Ansible Semaphore (HTTPS)
    # -----------------------------
    server {
        listen 443 ssl;
        server_name semaphoreui.hs;

        ssl_certificate     /etc/nginx/certs/jenkins.hs+6.pem;
        ssl_certificate_key /etc/nginx/certs/jenkins.hs+6-key.pem;

        location / {
            proxy_pass http://semaphore;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # WebSocket support for Semaphore
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    #
    # -----------------------------
    # Default server
    # -----------------------------
    server {
        listen 80 default_server;
        server_name _;
        return 404;
    }
}
